<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>Booker: Просмотр файла</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <style>
        #ocrResult h1 { font-size: 1.5rem; font-weight: bold; margin: 1em 0 0.5em 0; color: #1e293b; }
        #ocrResult h2 { font-size: 1.25rem; font-weight: bold; margin: 1em 0 0.5em 0; color: #334155; }
        #ocrResult h3 { font-size: 1.1rem; font-weight: bold; margin: 1em 0 0.5em 0; color: #475569; }
        #ocrResult p { margin: 0.5em 0; color: #374151; }
        #ocrResult ul, #ocrResult ol { margin: 0.5em 0 0.5em 1.5em; }
        #ocrResult li { margin: 0.25em 0; }
        #ocrResult pre { background: #f1f5f9; padding: 0.5em 1em; border-radius: 0.5em; overflow-x: auto; }
        #ocrResult code { background: #f3f4f6; padding: 0.1em 0.3em; border-radius: 0.3em; }
        #ocrResult blockquote { border-left: 4px solid #60a5fa; padding-left: 1em; color: #64748b; margin: 1em 0; }
        #ocrResult img { max-width: 100%; border-radius: 0.5em; margin: 0.5em 0; }
        #ocrResult hr { border: none; border-top: 1px solid #e5e7eb; margin: 1em 0; }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const file = "{{ file }}";
        let totalPages = 0;
        async function loadAllPages() {
            const meta = await fetch(`/metadata/${file}`).then(r => r.json());
            totalPages = parseInt(meta.metadata.Pages);
            const container = document.getElementById('all-pages');
            for (let page = 1; page <= totalPages; page++) {
                const pageDiv = document.createElement('div');
                pageDiv.className = 'flex flex-col items-center';
                pageDiv.innerHTML = `
                    <div class="font-semibold mb-2">Страница ${page}</div>
                    <img src="/preview/${file}/${page}" loading="lazy" class="rounded-lg border shadow max-h-[600px] mb-2">
                    <div id="ocr-result-${page}" class="prose prose-sm p-2 bg-gray-100 rounded text-gray-700 min-h-[2em]"></div>
                `;
                container.appendChild(pageDiv);

                // Загружаем OCR из кэша
                fetch(`/ocr_cache/${file}/${page}`)
                    .then(resp => resp.ok ? resp.json() : null)
                    .then(data => {
                        if (data && Array.isArray(data) && data[0]?.payload?.pages?.[0]?.markdown) {
                            const markdown = data[0].payload.pages[0].markdown;
                            const ocrDiv = document.getElementById(`ocr-result-${page}`);
                            ocrDiv.innerHTML = marked.parse(markdown);
                            if (window.renderMathInElement) {
                                renderMathInElement(ocrDiv, {
                                    delimiters: [
                                        {left: '$$', right: '$$', display: true},
                                        {left: '$', right: '$', display: false}
                                    ]
                                });
                            }
                        }
                    });
            }
        }
        async function runOcrAll() {
            document.getElementById('ocrProgress').textContent = 'Запуск OCR...';
            for (let page = 1; page <= totalPages; page++) {
                document.getElementById('ocrProgress').textContent = `Обработка страницы ${page} из ${totalPages}`;
                try {
                    const resp = await fetch(`/ocr/${file}/${page}`, {method: 'POST'});
                    const data = await resp.json();
                    const ocrDiv = document.getElementById(`ocr-result-${page}`);
                    ocrDiv.innerHTML = marked.parse(data.result || 'Ошибка');
                    if (window.renderMathInElement) {
                        renderMathInElement(ocrDiv, {
                            delimiters: [
                                {left: '$$', right: '$$', display: true},
                                {left: '$', right: '$', display: false}
                            ]
                        });
                    }
                } catch (e) {
                    document.getElementById(`ocr-result-${page}`).textContent = 'Ошибка';
                }
            }
            document.getElementById('ocrProgress').textContent = 'Готово!';
        }
        document.getElementById('ocrAllBtn').onclick = runOcrAll;
        loadAllPages();
    });
    </script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center py-8">
    <div class="w-full max-w-7xl bg-white rounded-xl shadow-lg p-8">
        <h1 class="text-2xl font-bold mb-4 text-gray-800">Просмотр файла</h1>
        <p class="mb-4 text-gray-600 break-all"><span class="font-semibold">Файл:</span> {{ file }}</p>
        <button id="ocrAllBtn" class="mb-6 px-6 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition">Запустить OCR для всех страниц</button>
        <div id="ocrProgress" class="mb-6 text-gray-600"></div>
        <div id="all-pages" class="flex flex-col gap-8"></div>
        <a href="/" class="inline-block mt-4 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg shadow hover:bg-gray-200 transition">Назад к списку</a>
    </div>
</body>
</html> 